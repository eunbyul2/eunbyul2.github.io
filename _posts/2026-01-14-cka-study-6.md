---
layout: post
title: "CKA 정리: Kubernetes 모니터링부터 Deployment RollingUpdate & Recreate"
date: 2026-01-14 20:00:00 +0900
categories: [Kubernetes, CKA]
tags: [kubernetes, cka, monitoring, metrics-server, cadvisor, logging, deployment, rollingupdate, recreate, rollback, rollout, revision]
published: true
---

## 1. Kubernetes 모니터링의 기본 개념

### 1-1) Kubernetes에서 왜 모니터링이 필요한가
- Kubernetes는 단일 서버가 아닌 **여러 노드와 수많은 Pod가 동시에 동작하는 분산 시스템**
- 애플리케이션이 정상인지 여부를 **프로세스 하나의 상태**로 판단할 수 없음.
- 따라서 “잘 돌아간다”를 감으로 판단할 수 없고, **리소스 사용량을 수치로 확인**해야 함.

모니터링의 목적은 다음 질문에 답하기 위함
- 지금 클러스터가 정상인가?
- 어떤 노드가 병목인가?
- 어떤 Pod가 리소스를 과도하게 사용하는가?
- 스케일링(HPA)이 일어나야 하는 상황인가?

이를 위해 Kubernetes에서는 크게 두 레벨의 메트릭을 봄.
#### Node 레벨
- 노드 개수
- 정상(Ready) 노드 수
- CPU / Memory 사용량

#### Pod 레벨
- Pod 개수
- Pod별 CPU / Memory 실제 사용량

### 1-2) Kubernetes에 기본 모니터링은 있을까?
결론부터 말하면:

- ❌ **완성형 모니터링 시스템은 기본 제공되지 않음**
- ✅ 최소한의 리소스 메트릭을 제공하는 컴포넌트는 존재

그 대표가 **Metrics Server**

## 2. Metrics Server란 무엇인가
### 2-1) Metrics Server의 역할
Metrics Server는 Kubernetes 클러스터의 **현재 시점 CPU/Memory 사용량**을 수집해  
**Metrics API** 형태로 제공하는 컴포넌트

- 클러스터당 1개만 설치
- 메트릭을 **메모리에만 저장(In-memory)**
- 과거 히스토리 조회 ❌
- `kubectl top` 명령의 데이터 소스
- HPA(Horizontal Pod Autoscaler)의 필수 구성요소

즉,
> **Metrics Server = “지금 이 순간의 리소스 상태만 알려주는 최소 구성”**

장기 저장, 알림, 시각화가 필요하면 Prometheus 같은 외부 시스템이 필요

### 2-2) Metrics Server는 직접 측정할까?
❌ 여기서 헷갈리기 쉬운 개념이 **cAdvisor**

Metrics Server는 **수집/집계자**이고,  
실제 측정은 **노드 내부 컴포넌트**가 담당

## 3. cAdvisor(Container Advisor) 정리
### 3-1) cAdvisor란?
cAdvisor(Container Advisor)는 **컨테이너의 실제 리소스 사용량을 실측**하는 컴포넌트

측정 대상:
- CPU
- Memory
- Network
- Filesystem

### 3-2) cAdvisor의 위치
- 별도 Pod ❌
- **kubelet 내부에 포함**
- 모든 노드에 기본 포함

즉, cAdvisor는 Kubernetes가 아니라 **노드 수준 컴포넌트**

### 3-3) 메트릭 흐름
```
Pod / Container
  ↓
cAdvisor (실제 측정)
  ↓
kubelet API
  ↓
Metrics Server (집계)
  ↓
kubectl top / HPA
```

이 흐름에서의 역할 분리:

- cAdvisor: **측정기**
- Metrics Server: **수집기**
- kubectl top: **조회 도구**

## 4. kubectl top 명령의 정확한 의미
### 4-1) 자주 헷갈린 질문
> “top은 메모리만 보는 명령어야?”

정답:
- ❌ 메모리만 아님
- ✅ **CPU + Memory 실제 사용량**

### 4-2) 명령어 예시
```bash
kubectl top node
kubectl top pod
```

이 값은:
- requests/limits ❌
- **실제 사용량(real usage)**

그래서 requests/limits와 값이 달라도 정상

## 5. Kubernetes 로깅의 기본 원리
### 5-1) stdout / stderr란?
모든 프로그램은 실행 시 3개의 표준 입출력 채널을 가짐.

| 번호 | 이름 | 의미 |
|---|---|---|
| 0 | stdin | 입력 |
| 1 | stdout | 정상 출력 |
| 2 | stderr | 에러 출력 |

Kubernetes 로그의 핵심 원칙:

> **컨테이너 로그 = stdout + stderr**

파일 로그를 직접 읽는 게 아님.

### 5-2) Docker vs Kubernetes 로그
- Docker:
  ```bash
  docker logs -f <container-id>
  ```
- Kubernetes:
  ```bash
  kubectl logs <pod-name>
  kubectl logs -f <pod-name>
  ```

원리는 동일하며, Kubernetes는 Pod 단위로 추상화되어 있을 뿐

### 5-3) 멀티 컨테이너 Pod에서의 로그
Pod에 컨테이너가 여러 개 있으면:

- Pod에 컨테이너가 2개 이상이면?
  ```bash
  kubectl logs <pod-name>
  ```
  ❌ 에러 발생

- 반드시 컨테이너 지정:
  ```bash
  kubectl logs <pod-name> -c <container-name>
  ```

## 6. 실습 문제에서 “이건 뭘 하라는 문제야?” 유형 정리

### 6-1) Logs 관련 문제
문제 예:
> A user is reporting issues while trying to purchase an item.

이건:
- YAML 작성 ❌
- 설정 변경 ❌
- **로그를 보고 원인 분석하는 문제**

해결 절차:
1. Pod 로그 확인
2. 사용자 식별
3. 에러 원인 식별

### 6-2) curl-test.sh 문제의 의도
```bash
bash /root/curl-test.sh
```

이 스크립트의 목적:
- 여러 요청을 보내 트래픽을 시뮬레이션
- 업데이트 전/중/후 동작 비교
- RollingUpdate vs Recreate 차이를 **눈으로 확인**

## 7. Deployment, Rollout, Revision 개념

### 7-1) Deployment 생성 시 내부 동작
- Deployment 생성 → **Rollout 발생**
- ReplicaSet 자동 생성
- ReplicaSet이 Pod 관리

### 7-2) Revision이란?
- Deployment의 변경 이력
- Pod 템플릿(spec.template) 변경 시 증가
- rollback의 기준점

## 8. RollingUpdate vs Recreate 전략

### 8-1) RollingUpdate (기본값)
- Pod를 하나씩 교체
- 서비스 지속
- 혼합 응답 발생 가능

```yaml
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 25%
    maxSurge: 25%
```

replicas=4일 때:
- 최대 1개 Pod만 down 가능

### 8-2) Recreate
- 기존 Pod 전부 종료
- 새 Pod 전부 생성
- **다운타임 발생 가능**

```yaml
strategy:
  type: Recreate
```

중요 포인트:
- Recreate에서는 `rollingUpdate` 필드 사용 불가

## 9. Deployment 업데이트 방법 비교

### 9-1) kubectl set image
```bash
kubectl set image deploy/frontend simple-webapp=kodekloud/webapp-color:v2
```

- Pod 템플릿만 수정
- 새 Rollout 트리거
- 파일 없이 가능

### 9-2) kubectl apply
- YAML 기준 상태 관리
- GitOps에 적합
- 오래된 YAML로 apply 시 **Conflict 위험**

### 9-3) kubectl patch (전략 변경의 정답)
```bash
kubectl patch deployment frontend --type='merge' -p '{"spec":{"strategy":{"type":"Recreate"}}}'
```

- 최신 리소스 기준
- 특정 필드만 안전하게 수정

## 10. Recreate 중 발생한 오류는 장애일까?

### 10-1) 질문 요약
> “Recreate 했을 때 502/Bad Gateway가 나오면 자동 복구되나?”

### 10-2) 정답
- ✅ **정상 동작**
- Recreate는 의도적으로 모든 Pod를 내림
- 새 Pod가 Ready 되면 자동 복구

복구 안 되는 경우:
- 이미지 자체 오류
- readinessProbe 실패
- 리소스 부족

## 11. 전체 흐름 한 줄 요약
- Metrics Server: 지금 상태 확인
- cAdvisor: 실제 측정 주체
- Logs: stdout/stderr 기반
- RollingUpdate: 무중단에 가까운 업데이트
- Recreate: 다운타임 허용, 끝나면 자동 복구