---
layout: post
title: "CKA 정리: Kubernetes Command/Args, Env, ConfigMap, Secret"
date: 2026-01-14 19::00 +0900
categories: [Kubernetes, CKA]
tags: [kubernetes, cka, command, args, env, configmap, secret, serviceaccount, etcd, encryption]
published: true
---

## 1) Docker에서 Command / CMD / ENTRYPOINT 이해하기

### 1-1) 컨테이너는 왜 바로 종료될까?
컨테이너는 **OS가 아니라 하나의 프로세스를 실행**하기 위한 환경입니다.

```bash
docker run ubuntu
```

- ubuntu 이미지의 기본 CMD는 `bash`
- bash는 **터미널 입력이 없으면 즉시 종료**
- 실행 중인 프로세스가 끝나면 컨테이너도 종료

컨테이너 생명주기 = **PID 1 프로세스 생명주기**

### 1-2) CMD와 ENTRYPOINT의 차이 (Docker)

```Dockerfile
CMD ["sleep", "5"]
```

```Dockerfile
ENTRYPOINT ["sleep"]
CMD ["5"]
```

| 구분 | 역할 |
|---|---|
| ENTRYPOINT | 실행할 **고정 명령** |
| CMD | 기본 인자(default args) |

```bash
docker run ubuntu-sleeper 10
```

- ENTRYPOINT = sleep
- CMD(5)는 덮어씌워짐 → `sleep 10`

### 1-3) JSON 배열 형태를 쓰는 이유

```Dockerfile
CMD sleep 5        # ❌ shell form
CMD ["sleep", "5"] # ⭕ exec form
```

- Kubernetes는 **exec form(JSON 배열)** 기준으로 동작
- 첫 요소는 실행 파일, 이후는 인자

## 2) Kubernetes에서 command / args

### 2-1) Docker 개념 ↔ Kubernetes 매핑

| Dockerfile | Pod spec |
|---|---|
| ENTRYPOINT | command |
| CMD | args |

이름이 헷갈리지만 **의미는 반대처럼 보일 수 있음**

### 2-2) sleep Pod 예제

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-sleeper
spec:
  containers:
  - name: ubuntu
    image: ubuntu
    command: ["sleep"]
    args: ["5000"]
```

실제 실행:
```bash
sleep 5000
```

### 2-3) 배열 표기 두 가지

```yaml
command: ["sleep", "5000"]
```

```yaml
command:
  - "sleep"
  - "5000"
```

- 완전히 동일
- 숫자라도 **문자열로 써야 함**

### 2-4) Pod는 왜 edit이 안 될까?
Pod는 **불변 객체(Immutable)**

변경 불가 항목:
- command
- args
- env

가능한 방법:
```bash
kubectl delete pod <pod>
# 또는
kubectl replace --force -f pod.yaml
```

## 3) kubectl run 에서 -- 의 의미

### 3-1) -- 는 옵션 경계자

```bash
kubectl run webapp-green \
  --image=kodekloud/webapp-color \
  -- --color=green
```

| 위치 | 의미 |
|---|---|
| -- 앞 | kubectl 옵션 |
| -- 뒤 | **컨테이너에 전달할 인자(args)** |

### 3-2) 왜 필요한가?
- kubectl도 옵션을 가지고 있고, 컨테이너 내부 앱도 옵션을 가짐

**충돌 방지용 구분자**

## 4) 환경 변수 (env)

### 4-1) Pod에 직접 env 지정

```yaml
env:
- name: APP_COLOR
  value: green
```

가장 단순하지만, Pod 많아지면 관리 지옥

## 5) ConfigMap

### 5-1) ConfigMap이 필요한 이유

- 설정과 애플리케이션 분리
- 중앙 관리
- 여러 Pod에서 재사용

### 5-2) ConfigMap 생성 (imperative)

```bash
kubectl create configmap webapp-config \
  --from-literal=APP_COLOR=blue
```

### 5-3) ConfigMap 생성 (declarative)

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config
data:
  APP_COLOR: blue
```

### 5-4) Pod에 ConfigMap 주입

#### 전체 주입

```yaml
envFrom:
- configMapRef:
    name: webapp-config
```

#### 단일 키 주입

```yaml
env:
- name: APP_COLOR
  valueFrom:
    configMapKeyRef:
      name: webapp-config
      key: APP_COLOR
```

## 6) Secret

### 6-1) Secret vs ConfigMap

| 항목 | ConfigMap | Secret |
|---|---|---|
| 용도 | 설정 | 비밀정보 |
| 저장 | 평문 | Base64 |
| 보안 | ❌ | ⚠️ (인코딩뿐) |

### 6-2) Secret 생성 (imperative)

```bash
kubectl create secret generic db-secret \
  --from-literal=DB_Host=sql01 \
  --from-literal=DB_User=root \
  --from-literal=DB_Password=password123
```

자동으로 Base64 인코딩됨

### 6-3) Secret 생성 (declarative)

```bash
echo -n password123 | base64
```

```yaml
data:
  DB_Password: cGFzc3dvcmQxMjM=
```

### 6-4) Pod에 Secret 주입

```yaml
envFrom:
- secretRef:
    name: db-secret
```

## 7) ServiceAccount Secret 이해

### 7-1) dashboard-token Secret

```bash
kubectl describe secret dashboard-token
```

### 7-2) ServiceAccount란?

- Pod가 Kubernetes API와 통신할 때 사용하는 **신원(identity)**
- 자동으로 Secret(token) 생성됨

## 8) Base64 ≠ 암호화

```bash
echo cGFzc3dvcmQxMjM= | base64 --decode
```

- 누구나 복호화 가능
- Secret은 **암호화가 아니라 인코딩**

## 9) Encryption at Rest (etcd)

### 9-1) 왜 필요한가?

- Secret은 etcd에 **평문 저장**
- etcd 접근 시 모든 Secret 노출

### 9-2) Encryption at Rest란?

- etcd에 저장되는 데이터를 **암호화하여 저장**
- kube-apiserver만 복호화 가능

### 9-3) 핵심 개념

- Base64: 사용자 보기용
- Encryption at Rest: **저장소 보호용**

### 9-4) head -c 32 의미

```bash
head -c 32 /dev/urandom | base64
```

- c = characters(bytes)
- 32바이트 랜덤 키 생성
- 암호화 키로 사용

## 10) Secret Best Practices

- ❌ Git에 Secret YAML 올리지 않기
- ⭕ Encryption at Rest 활성화
- ⭕ RBAC 최소 권한
- ⭕ Pod 삭제 시 Secret 자동 제거

> **Secret은 안전한 금고가 아니라, 안전하게 다루기 위한 표준 절차다.**